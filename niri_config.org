# -*- indent-tabs-mode: nil; coding: utf-8-unix; -*-
#+PROPERTY: header-args :results value silent

#+TITLE: Niri Config.kdl

* Overview
#+BEGIN_SRC kdl :tangle ./config.kdl :noweb yes :results value :eval no
  // LAST BUILD / DEPLOY: <<timestamp()>>
  // ## NOTES  ###########################################################  
  // This config file has been created by emacs org babel. This was done
  // mostly as a learning experiment and to address the gaps that .kdl
  // files have such as use of variables or access to env. variables etc.
  //
  // To generate this file without automation do the following (these are
  // notes to myself as I will forget this since once the changes
  // become stable I doubt I will remember any of this:
  
  // 1) Open ~/.config/org/babel/niri_config/niri_config.org
  
  // 2) M-x org-babel-execute-buffer (This will evaluate all of the code
  // blocks that have been marked for evaluation and display the results
  // just below the code block. To evaluate any code block place the
  // cursor inside the code block and C-c C-c.
  
  // 3) While inside of the niri_config.org file M-x org-babel-tangle
  // This will produce the config.kdl file in the niri_config dir.
  
  // 4) Copy config.kdl and key_bindings.txt to the niri directory.
  
  // 5) To run steps 1-4 fully automated M-x niri-build-and-deploy. The
  // live config.kdl will be copied to config.999, where 999 is a
  // sequencial number and also keep the last 5 copies for rollback.
  //
  // I am using the archcraft distro which uses pywal. Anytime a new theme
  // is generated it generates a new colors.sh file that is applied all
  // the basic shell apps. The niri_config.org babel imports this file
  // and applies the colors to the niri config where applicable. This is
  // experimental as there are not really many places to apply colors to
  // a wtm in general (e.g. border, background).
#+END_SRC

* Date/Timestamp of Last Update/Deployment
#+name: timestamp
#+begin_src python :results value
from datetime import datetime
return datetime.now().strftime("%Y-%m-%d %H:%M:%S")
#+end_src

* Target System
I have multiple systems (e.g. laptop, desktop, pi) that need different configurations mostly as
it relates to monitor, workspace and some limited customization if keybindings. Change the
return value to be either "desktop", "laptop", or "pi" based on the target system.
#+name: target-system
#+begin_src python :results value
  return "desktop"
#+end_src

* Variables - Colors
I currently use archraft as my base distro which included pywal for themeing. This section
integrates the archcraft themeing approach by loading the colors.css file and applying
them in a few areas like focued / unfocused window ring / border.
#+name: theme-colors-json-old
#+begin_src python :results value
import json

theme = {}
with open("/home/username/.cache/wal/colors.sh", "r") as f:
    for line in f:
        line = line.strip()
        if line.startswith("#") or "=" not in line:
            continue
        if line.startswith("export"):
            line = line.replace("export", "", 1).strip()
        key, val = map(str.strip, line.split("=", 1))
        val = val.strip("'\"")
        theme[key] = val

return json.dumps(theme)
#+end_src

#+name: theme-colors-json
#+begin_src python :results value :var ts=target-system
  import json, os

  # --- Fallback palette (tweak to taste) ---
  DEFAULTS = {
      "background": "#1e1e2e",
      "foreground": "#cdd6f4",
      "color0":  "#45475a",
      "color1":  "#f38ba8",
      "color2":  "#a6e3a1",
      "color3":  "#f9e2af",
      "color4":  "#89b4fa",
      "color5":  "#cba6f7",
      "color6":  "#94e2d5",
      "color7":  "#bac2de",
      "color8":  "#585b70",
      "color9":  "#f28fad",
      "color10": "#b9e58c",
      "color11": "#f7d794",
      "color12": "#99c1f1",
      "color13": "#d0a8ff",
      "color14": "#a6e1e0",
      "color15": "#ffffff",
  }

  def load_colors_sh(path):
      theme = DEFAULTS.copy()
      try:
          with open(path, "r") as f:
              for line in f:
                  line = line.strip()
                  if not line or line.startswith("#") or "=" not in line:
                      continue    # 
                  if line.startswith("export"):
                      line = line.replace("export", "", 1).strip()
                  key, val = map(str.strip, line.split("=", 1))
                  val = val.strip("'\"")
                  theme[key] = val
      except FileNotFoundError:
          # fall back to defaults silently
          pass
      return theme

  ts_norm = (ts or "").strip().lower()

  if ts_norm == "pi":
      theme = DEFAULTS.copy()
  else:
      colors_path = os.path.expanduser("~/.cache/wal/colors.sh")
      theme = load_colors_sh(colors_path)

  # Ensure all expected keys exist
  for k, v in DEFAULTS.items():
      theme.setdefault(k, v)

  return json.dumps(theme)
#+end_src


#+name: colors-dict
#+begin_src python :var colors_raw=theme-colors-json :results value
  # [colors.normal]
  # black   = "${color0}"
  # red     = "${color1}"
  # green   = "${color2}"
  # yellow  = "${color3}"
  # blue    = "${color4}"
  # magenta = "${color5}"
  # cyan    = "${color6}"
  # white   = "${color7}"
  	
  # [colors.bright]
  # black   = "${color8}"
  # red     = "${color9}"
  # green   = "${color10}"
  # yellow  = "${color11}"
  # blue    = "${color12}"
  # magenta = "${color13}"
  # cyan    = "${color14}"
  # white   = "${color15}"

  # background = background
  # foreground = foreground

import json  
colors = json.loads(colors_raw)
return colors
#+end_src

#+name: background
#+begin_src python :var colors_raw=theme-colors-json :results value
import json
colors = json.loads(colors_raw)
return colors["background"]
#+end_src

#+name: foreground
#+begin_src python :var colors_raw=theme-colors-json :results value
import json
colors = json.loads(colors_raw)
return colors["foreground"]
#+end_src

#+name: color0
#+begin_src python :var colors_raw=theme-colors-json :results value
import json
colors = json.loads(colors_raw)
return colors["color0"]
#+end_src

#+name: color1
#+begin_src python :var colors_raw=theme-colors-json :results value
import json
colors = json.loads(colors_raw)
return colors["color1"]
#+end_src

#+name: color2
#+begin_src python :var colors_raw=theme-colors-json :results value
import json
colors = json.loads(colors_raw)
return colors["color2"]
#+end_src

#+name: color3
#+begin_src python :var colors_raw=theme-colors-json :results value
import json
colors = json.loads(colors_raw)
return colors["color3"]
#+end_src

#+name: color4
#+begin_src python :var colors_raw=theme-colors-json :results value
import json
colors = json.loads(colors_raw)
return colors["color4"]
#+end_src

#+name: color5
#+begin_src python :var colors_raw=theme-colors-json :results value
import json
colors = json.loads(colors_raw)
return colors["color5"]
#+end_src

#+name: color6
#+begin_src python :var colors_raw=theme-colors-json :results value
import json
colors = json.loads(colors_raw)
return colors["color6"]
#+end_src

#+name: color7
#+begin_src python :var colors_raw=theme-colors-json :results value
import json
colors = json.loads(colors_raw)
return colors["color7"]
#+end_src

#+name: color8
#+begin_src python :var colors_raw=theme-colors-json :results value
import json
colors = json.loads(colors_raw)
return colors["color8"]
#+end_src

#+name: color9
#+begin_src python :var colors_raw=theme-colors-json :results value
import json
colors = json.loads(colors_raw)
return colors["color9"]
#+end_src

#+name: color10
#+begin_src python :var colors_raw=theme-colors-json :results value
import json
colors = json.loads(colors_raw)
return colors["color10"]
#+end_src

#+name: color11
#+begin_src python :var colors_raw=theme-colors-json :results value
import json
colors = json.loads(colors_raw)
return colors["color11"]
#+end_src

#+name: color12
#+begin_src python :var colors_raw=theme-colors-json :results value
import json
colors = json.loads(colors_raw)
return colors["color12"]
#+end_src

#+name: color13
#+begin_src python :var colors_raw=theme-colors-json :results value
import json
colors = json.loads(colors_raw)
return colors["color13"]
#+end_src

#+name: color14
#+begin_src python :var colors_raw=theme-colors-json :results value
import json
colors = json.loads(colors_raw)
return colors["color14"]
#+end_src

#+name: color15
#+begin_src python :var colors_raw=theme-colors-json :results value
import json
colors = json.loads(colors_raw)
return colors["color15"]
#+end_src

* Variables - Paths
All shared niri variables are set in this section. This overcomes the limitation that .kdl
has in using variables. Other ways to work around this in niri is to place most logic
in shell scripts which simplifies constructing commands.
#+NAME: niri_scripts
#+BEGIN_SRC python :results value
  return "~/.config/niri/scripts"
#+END_SRC

#+NAME: niri_theme
#+BEGIN_SRC python :results value
  return "~/.config/niri/theme"
#+END_SRC

#+NAME: niri_toolkit
#+BEGIN_SRC python :results value
  return "~/projects/niri_toolkit"
#+END_SRC

#+NAME: screenshot_path
#+BEGIN_SRC python :results value
  return "~/Pictures/screenshots"
#+END_SRC

#+NAME: screenshot_file
#+BEGIN_SRC python :results value
  return "Screenshot-from-%Y-%m-%d-%H-%M-%S.png"  
#+END_SRC

* Variables - Apps & Scripts
All my applications and shells scripts are set to variables here. This gives a little bit more
flexibility in constructing more complex statements mostly in the use of quoting. This also
give you the opportunity to execute some preprocessing logic if necessary.
#+NAME: bindings
#+BEGIN_SRC python :var _temp=niri_scripts :results value
  _temp = f'{_temp}/rofi_bindings'
  return f'"\\"{_temp}\\""'  
#+END_SRC

#+NAME: lobindings
#+BEGIN_SRC python :var _temp=niri_scripts :results value
  _temp = f'{_temp}/rofi_lobindings'
  return f'"\\"{_temp}\\""'  
#+END_SRC

#+NAME: launcher
#+BEGIN_SRC python :var _temp=niri_scripts :results value
  _temp = f"{_temp}/rofi_launcher"
  return f'"\\"{_temp}\\""'    
#+END_SRC

#+NAME: bluetooth
#+BEGIN_SRC python :var _temp=niri_scripts :results value
  _temp = f"{_temp}/rofi_bluetooth"
  return f'"\\"{_temp}\\""'    
#+END_SRC


#+NAME: power_menu
#+BEGIN_SRC python :var _temp=niri_scripts :results value
  _temp = f"{_temp}/rofi_powermenu"
  return f'"\\"{_temp}\\""'    
#+END_SRC

#+NAME: music
#+BEGIN_SRC python :var _temp=niri_scripts :results value
  _temp = f"{_temp}/rofi_music"
  return f'"\\"{_temp}\\""'    
#+END_SRC

#+NAME: network
#+BEGIN_SRC python :var _temp=niri_scripts :results value
  _temp = f"{_temp}/rofi_network"
  return f'"\\"{_temp}\\""'    
#+END_SRC

#+NAME: show_windows
#+BEGIN_SRC python :var _temp=niri_scripts :results value
  _temp = f"{_temp}/rofi_showwindows"
  return f'"\\"{_temp}\\""'    
#+END_SRC

#+NAME: term
#+BEGIN_SRC python :var _temp=niri_scripts :results value
  _temp = f"{_temp}/alacritty"
  return f'"\\"{_temp}\\""'    
#+END_SRC

#+NAME: term_foot
#+BEGIN_SRC python :var _temp=niri_scripts :results value
  _temp = f"{_temp}/foot"
  return f'"\\"{_temp}\\""'    
#+END_SRC

#+NAME: term_wezterm
#+BEGIN_SRC python :results value
  cmd = [
      '"sh"',
      '"-c"',
      '"wezterm"'
  ]
  return " ".join(cmd)  
#+END_SRC

#+NAME: lock_screen
#+BEGIN_SRC python :var _temp=niri_scripts :results value
  _temp = f"{_temp}/lockscreen"
  return f'"\\"{_temp}\\""'    
#+END_SRC

#+NAME: scratchpad_put
#+BEGIN_SRC python :var _temp=niri_toolkit :results value
  _temp = f"{_temp}/niri_scratchpad"  
  cmd = [
      f'"{_temp}"',
      '"--action"', '"put"',
      '"--scratchpad_name"', '"scratchpad"'
  ]
  return " ".join(cmd)  
#+END_SRC

#+NAME: scratchpad_get
#+BEGIN_SRC python :var _temp=niri_toolkit :results value
  _temp = f"{_temp}/niri_scratchpad"    
  cmd = [
      f'"{_temp}"',
      '"--action"', '"get"',
      '"--scratchpad_name"', '"scratchpad"'
  ]
  return " ".join(cmd)  
#+END_SRC

#+NAME: emacs_prod
#+BEGIN_SRC python :results value
      cmd = [
          '"emacsclient"',
          '"-c"',
          '"-s"', '"emacs-prod"'
      ]
      return " ".join(cmd)  
#+END_SRC

#+NAME: emacs_dev
#+BEGIN_SRC python :results value
    cmd = [
        '"emacsclient"',
        '"-c"', 
        '"-s"', '"emacs-dev"'
    ]
    return " ".join(cmd)  
#+END_SRC

#+NAME: file_gui
#+BEGIN_SRC python
  return f'"\\"thunar\\""'
#+END_SRC


#+NAME: file_term
#+BEGIN_SRC python :results value
cmd = [
    '"sh"',
    '"-c"', '"kitty --detach yazi"'
]
return " ".join(cmd)
#+END_SRC

#+NAME: browser
#+BEGIN_SRC python
  return f'"\\"vivaldi-snapshot\\""'
#+END_SRC

#+NAME: notes
#+BEGIN_SRC python
  return f'"\\"pluma\\""'  
#+END_SRC

#+NAME: email_get
#+BEGIN_SRC python :var _temp=niri_toolkit :results value
  _temp = f"{_temp}/niri-move-window.py"
  cmd = [
      f'"{_temp}"',
      '"--match"', '"mu4e"',
      '"--target"', '"m"',
      '"--target_id"', '"Samsung Electric Company S24R35xFZ H4TT200346"',
      '"--focus"'
  ]
  return " ".join(cmd)
#+END_SRC

#+NAME: email_put
#+BEGIN_SRC python :var _temp=niri_toolkit :results value
  _temp = f"{_temp}/niri-move-window.py"
  cmd = [
      f'"{_temp}"',
      '"--match"', '"mu4e"',
      '"--target"', '"w"',
      '"--target_id"', '"messaging"'
  ]
  return " ".join(cmd)
#+END_SRC

#+NAME: sms_get
#+BEGIN_SRC python :var _temp=niri_toolkit :results value
  _temp = f"{_temp}/niri-move-window.py"
  cmd = [
      f'"{_temp}"',
      '"--match"', '"Messages"',
      '"--target"', '"m"',
      '"--target_id"', '"Samsung Electric Company S24R35xFZ H4TT200346"',
      '"--focus"'
  ]
  return " ".join(cmd)
#+END_SRC

#+NAME: sms_put
#+BEGIN_SRC python :var _temp=niri_toolkit :results value
  _temp = f"{_temp}/niri-move-window.py"
  cmd = [
      f'"{_temp}"',
      '"--match"', '"Messages"',
      '"--target"', '"w"',
      '"--target_id"', '"messaging"'
  ]
  return " ".join(cmd)
#+END_SRC

#+NAME: audio_raise_volume
#+BEGIN_SRC python :results value
  cmd = [
      '"wpctl"',
      '"set-volume"',
      '"@DEFAULT_AUDIO_SINK@"',
      '"5%+"'
  ]
  return " ".join(cmd)
#+END_SRC

#+NAME: audio_lower_volume
#+BEGIN_SRC python :results value
  cmd = [
      '"wpctl"',
      '"set-volume"',
      '"@DEFAULT_AUDIO_SINK@"',
      '"5%-"'
  ]
  return " ".join(cmd)
#+END_SRC

#+NAME: audio_mute
#+BEGIN_SRC python :results value
  cmd = [
      '"wpctl"',
      '"set-mute"',
      '"@DEFAULT_AUDIO_SINK@"',
      '"toggle"'
  ]
  return " ".join(cmd)
#+END_SRC

#+NAME: audio_mic_mute
#+BEGIN_SRC python :results value
  cmd = [
      '"wpctl"',
      '"set-mute"',
      '"@DEFAULT_AUDIO_SOURCE@"',
      '"toggle"'
  ]
  return " ".join(cmd)
#+END_SRC


#+NAME: idle_lock
#+BEGIN_SRC python :var _temp=niri_scripts :results value
  _temp = f"{_temp}/lockscreen"
  cmd = [
      '"sh"',
      '"-c"',
      f'"swayidle -w timeout 600 {_temp}"'      
  ]
  return " ".join(cmd)
#+END_SRC

#+NAME: setup_theme
#+BEGIN_SRC python :var _temp=niri_scripts :results value
  _temp = f"{_temp}/setup_theme"
  return f'"\\"{_temp}\\""'    
#+END_SRC

#+NAME: wallpaper
#+BEGIN_SRC python :var _temp=niri_scripts :results value
  _temp = f"{_temp}/wallpaper"
  return f'"\\"{_temp}\\""'    
#+END_SRC

#+NAME: wallpaper_switch
#+BEGIN_SRC python :var _temp=niri_scripts :results value
  _temp = f"{_temp}/wallpaper_switch"
  return f'"\\"{_temp}\\""'    
#+END_SRC

#+NAME: notifications
#+BEGIN_SRC python :var _temp=niri_scripts :results value
  _temp = f"{_temp}/notifications"
  return f'"\\"{_temp}\\""'    
#+END_SRC

#+NAME: status_bar_waybar
#+BEGIN_SRC python :var _temp=niri_scripts :results value
  _temp = f"{_temp}/statusbar"
  return f'"\\"{_temp}\\""'    
#+END_SRC

#+NAME: status_bar_dms
#+BEGIN_SRC python :results value
  cmd = [
      '"dms"',
      '"run"'
  ]
  return " ".join(cmd)
#+END_SRC

#+NAME: clipboard
#+BEGIN_SRC python :results value
  cmd = [
      '"bash"',
      '"-c"',
      '"wl-paste --watch cliphist store &"'
  ]
  return " ".join(cmd)
#+END_SRC

#+NAME: spotify
#+BEGIN_SRC python
  return f'"\\"spotify\\""'      
#+END_SRC

#+NAME: element
#+BEGIN_SRC python
  return f'"\\"element-desktop\\""'  
#+END_SRC

#+NAME: sms
#+BEGIN_SRC python
  cmd = [
      '"qutebrowser"',
      '"https://messages.google.com"'
  ]
  return " ".join(cmd)
#+END_SRC

#+NAME: calendar
#+BEGIN_SRC python
  cmd = [
      '"qutebrowser"',
      '"https://calendar.google.com"'
  ]
  return " ".join(cmd)
#+END_SRC

#+NAME: discord
#+BEGIN_SRC python
  return f'"\\"vesktop\\""'  
#+END_SRC

#+NAME: email
#+BEGIN_SRC python
  return f'"\\"geary\\""'  
#+END_SRC

#+NAME: xwayland
#+BEGIN_SRC python
  return f'"\\"xwayland-satellite\\""'  
#+END_SRC

#+NAME: screenshot_viewer
#+BEGIN_SRC python :var _temp=niri_toolkit :results value
  _temp = f"{_temp}/niri-screenshot-picker"
  return f'"\\"{_temp}\\""'    
#+END_SRC

#+NAME: screenshot_viewer_emacs
#+BEGIN_SRC python :var _temp=niri_toolkit :results value
  _temp = f"{_temp}/niri-screenshot-picker-emacs"
  return f'"\\"{_temp}\\""'    
#+END_SRC

#+NAME: niri_hot_change
#+BEGIN_SRC python :var _temp=niri_toolkit :results value
  _temp = f"{_temp}/niri-hot-change"
  return f'"\\"{_temp}\\""'    
#+END_SRC

#+NAME: niri_theme_change
#+BEGIN_SRC python :var _temp=niri_theme :results value
  _temp = f"{_temp}/theme.sh"
  cmd = [
      f'"{_temp}"',
      '"--pywal"'
  ]
  return " ".join(cmd)
#+END_SRC

* Environment
This sets the niri environment variables. You can also pull environment variables in
externally if you need reference to them which is a limitation in .kdl.  Currently
I only need to set the DISPLAY variable for xwayland.
#+BEGIN_SRC kdl :tangle ./config.kdl :eval no
  environment {
          DISPLAY ":1"
  }
#+END_SRC

* Inputs
This section defined inputs such as keyboard, mouse, pen etc. Focus follows mouse it
probably the most critical setting for my use so that when hovering a mouse over
a windows the focus also it set to the window being hovered. I have adopted this sam
behaviour in emacs since using tile managers.
#+BEGIN_SRC kdl :tangle ./config.kdl :eval no
  input {
          keyboard {
                  xkb {
                     // layout "us,ru"
                     // options "grp:win_space_toggle,compose:ralt,ctrl:nocaps"
                  }
                  numlock
          }

          touchpad {
                  // off
                  tap
                  // dwt
                  // dwtp
                  // drag false
                  // drag-lock
                  natural-scroll
                  // accel-speed 0.2
                  // accel-profile "flat"
                  // scroll-method "two-finger"
                  // disabled-on-external-mouse
          }

          mouse {
                  // off
                  natural-scroll
                  accel-speed -0.5
                  accel-profile "flat"
                  scroll-method "no-scroll"
          }

          trackpoint {
                  // off
                  // natural-scroll
                  // accel-speed 0.2
                  // accel-profile "flat"
                  // scroll-method "on-button-down"
                  // scroll-button 273
                  // middle-emulation
          }

          warp-mouse-to-focus

          focus-follows-mouse max-scroll-amount="50%"
  }
#+END_SRC

* Outputs
This section sets the monitor configurations. These are different across environments so there
has to be evaluation performed to determine which monitor configurations get exported to config.kdl.
I've chose emacs-lisp for this because I found the string manipulation to be a little simper than
python, although I'm sure most of it is a limitation in my knowledge.
#+NAME: output_config
#+BEGIN_SRC python :eval yes :var ts=target-system
  def desktop():
      
      return """output "Samsung Electric Company S24R35xFZ H4TT200322" {
      // off
      mode "1920x1080@60"
      scale 1
      transform "normal"
      position x=0 y=0
  }

  output "Samsung Electric Company S24R35xFZ H4TT200346" {
      // off
      mode "1920x1080@60"
      scale 1
      transform "normal"
      position x=1920 y=0
  }

  output "Sceptre Tech Inc Sceptre E24 0x01010101" {
      // off
      mode "1920x1080@60"
      scale 1
      transform "normal"
      position x=3840 y=0
  }"""

  def laptop():
      return """output "eDP1" {
      // off
      mode "1920x1080@60"
      scale 1
      transform "normal"
      position x=0 y=0
  }"""

  def pi():
      return """output "HDMI-A-1" {
      // off
      mode "1920x1080@60"
      scale 1
      transform "normal"
      position x=0 y=0
  }"""

  def main(target):
      target = str(target).strip().lower()
      table = {
          "desktop": desktop,
          "laptop": laptop,
          "pi": pi,
      }
      fn = table.get(target)
      if not fn:
          raise ValueError(f"Unknown target-system: {target!r}. "
                           f"Expected one of: {', '.join(table)}")
      return fn()

  return main(ts)
#+END_SRC

#+BEGIN_SRC kdl :noweb yes :tangle ./config.kdl :eval no
<<output_config()>>
#+END_SRC

* Startup Apps
These are the apps that startup when niri starts. This actually works better in my opinion just
putting all these in a single shell script and calling the shell script which enables
preprocessing and progamatic control to ensure they startup in the correct sequence etc.
#+NAME: startup_apps
#+BEGIN_SRC python :results value :eval yes :var ts=target-system xw=xwayland il=idle_lock st=setup_theme wp=wallpaper nt=notifications sp=spotify el=element sm=sms cal=calendar dc=discord cb=clipboard sb=status_bar_dms sw=status_bar_waybar W=24
kw = "spawn-at-startup"
fmt = f"{{:{W}}}"

def line(cmd: str) -> str:
    return f"{fmt.format(kw)} {cmd}"

# Define per-host sequences using the variables you already pass in.
profiles = {
    "desktop": [xw, il, st, wp, nt, sp, el, dc, cb, sm, cal, sb],
    "laptop":  [xw, il, nt, sm, cal, sb],
    "pi":      [xw, il, sw, nt],
}

# Keep only non-empty entries (lets you omit any var cleanly)
commands = [c for c in profiles[ts] if c]
return "\n".join(line(c) for c in commands)
#+END_SRC

#+BEGIN_SRC kdl :noweb yes :tangle ./config.kdl :eval no
  <<startup_apps()>>
#+END_SRC

* Workspaces
This where I setup my static workspaces. These are mostly used for my 3 monitor setup, where I have
a dedicated monitor for these workspaces. Similar to output there needs to be evaluation to determine
the target system as this is different between my desktop and laptop.
#+NAME: workspace_config
#+BEGIN_SRC python :eval yes :var ts=target-system
def desktop():
    return """
workspace "scratchpad" {
        open-on-output "Sceptre Tech Inc Sceptre E24 0x01010101"
}

workspace "messaging" {
        open-on-output "Sceptre Tech Inc Sceptre E24 0x01010101"
}

workspace "spotify" {
        open-on-output "Sceptre Tech Inc Sceptre E24 0x01010101"
}

workspace "cameras" {
        open-on-output "Sceptre Tech Inc Sceptre E24 0x01010101"
}

workspace "virtbox" {
        open-on-output "Sceptre Tech Inc Sceptre E24 0x01010101"
}

workspace "discord" {
        open-on-output "Sceptre Tech Inc Sceptre E24 0x01010101"
}

workspace "element" {
        open-on-output "Sceptre Tech Inc Sceptre E24 0x01010101"
}
"""

def laptop():
    return """
workspace "scratchpad" {
}

workspace "spotify" {
}

workspace "discord" {
}

workspace "element" {
}

workspace "messaging" {
}
"""

def pi():
    return """
workspace "scratchpad" {
}
"""

def main(target):
    target = str(target).strip().lower()
    table = {
        "desktop": desktop,
        "laptop": laptop,
        "pi": pi,
    }
    fn = table.get(target)
    if not fn:
        raise ValueError(f"Unknown target-system: {target!r}. "
                         f"Expected one of: {', '.join(table)}")
    return fn()

return main(ts)
#+END_SRC

#+BEGIN_SRC kdl :noweb yes :tangle ./config.kdl :eval no
<<workspace_config()>>
#+END_SRC

#+BEGIN_SRC kdl :noweb yes :tangle ./config.kdl :eval no :tangle ./config.kdl
  hotkey-overlay {
          skip-at-startup
  }
#+END_SRC

* Layout
This section defines the basic layout, decorations and animations. Since niri supports hot
loading a config, I've toyed with the idea of creating a popup based on this content that
will allow me to change it on the fly and save the configurations to reapply periodically.
So for example, you would hit key sequence which pops up a window of these values, alter
the values save the config and apply. This would allow for quick visual changes to fine tune
QOL.
#+BEGIN_SRC kdl :tangle ./config.kdl :noweb yes :eval no :results value
      layout {
              gaps 4

              center-focused-column "never"
            
              always-center-single-column

              preset-column-widths {
                      proportion 0.33333
                      proportion 0.5
                      proportion 0.66667
                      proportion 0.9
                      proportion 1.0
              }

              // preset-window-heights { }

              // default-column-width { proportion 0.5; }

              default-column-width {}

              // draw-border-with-background

              background-color "transparent"

              focus-ring {
                      // off
                      width 2
                      active-color "<<color4()>>"
                      inactive-color "<<background()>>"
                      // active-gradient from="#80c8ff" to="#bbddff" angle=45
                      // inactive-gradient from="#505050" to="#808080" angle=45 relative-to="workspace-view"
              }


              border {
                      off
                      width 1
                      active-color "#ffc87f"
                      inactive-color "#505050"
                      urgent-color "#9b0000"
                      active-gradient from="#ffbb66" to="#ffc880" angle=45 relative-to="workspace-view"
                      inactive-gradient from="#505050" to="#808080" angle=45 relative-to="workspace-view"
              }
              
              shadow {
                      // on
                      draw-behind-window false
                      softness 30
                      spread 5
                      offset x=0 y=5
                      color "#00000080"
                      inactive-color "#00000060"
              }

              struts {
                      left 0
                      right 0
                      top 0
                      bottom 0
              }

              tab-indicator {
                      // off
                      hide-when-single-tab
                      place-within-column
                      gap 5
                      width 15
                      length total-proportion=1.0
                      position "top"
                      gaps-between-tabs 5
                      corner-radius 8
                      active-color "bf616a"
                      inactive-color "gray"
                      // active-gradient from="#80c8ff" to="#bbddff" angle=45
                      // inactive-gradient from="#505050" to="#808080" angle=45 relative-to="workspace-view"
              }

              insert-hint {
                      // off
                      color "#ffc87f80"
                      gradient from="#ffbb6680" to="#ffc88080" angle=45 relative-to="workspace-view"
              }
      }

      prefer-no-csd

      screenshot-path "<<screenshot_path()>>/<<screenshot_file()>>"


      animations {
          // off

       workspace-switch {
                      spring damping-ratio=2.0 stiffness=1000 epsilon=0.0001
              }

              window-open {
                      duration-ms 250
                      curve "ease-out-cubic"
              }

              window-close {
                      duration-ms 250
                      curve "ease-out-quad"
              }

              horizontal-view-movement {
                      spring damping-ratio=2.0 stiffness=500 epsilon=0.0001
              }

              window-movement {
                      spring damping-ratio=2.0 stiffness=500 epsilon=0.0001
              }

              window-resize {
                      spring damping-ratio=2.0 stiffness=500 epsilon=0.0001
              }

              config-notification-open-close {
                      spring damping-ratio=0.6 stiffness=500 epsilon=0.001
              }

              screenshot-ui-open {
                      duration-ms 200
                      curve "ease-out-quad"
              }

              overview-open-close {
                      spring damping-ratio=2.0 stiffness=500 epsilon=0.0001
              }

      }

      cursor {
              xcursor-theme "Qogirr"
              xcursor-size 12
              hide-when-typing
              //hide-after-inactive-ms 1000
      }

      overview {
      	// backdrop-color "#566870"
              zoom 0.3
              workspace-shadow {
      	 	off
      	}
      }
#+END_SRC

* Window Rules
This section defines the window rules for my windows. I mostly use this to set an app to
floating / size and to assign the app to a specific workspace.
#+BEGIN_SRC kdl :tangle ./config.kdl :eval no
      window-rule {
              default-column-width {}
              geometry-corner-radius 10
              clip-to-geometry true
              draw-border-with-background false
              opacity 0.60
      }

      window-rule {
              match is-active=true
              opacity 1.0
      }

      window-rule {
              match app-id="pluma"
              open-floating true
      }

      window-rule {
              match app-id="Sxiv"
              open-floating true
              open-fullscreen true
      }

      window-rule {
              match app-id="emacs"
              open-floating false
              open-maximized true
      }

      window-rule {
              match app-id="org.pwmt.zathura"
              open-floating true
              default-column-width { fixed 900; }
              default-window-height { fixed 900; }
      }

      window-rule {
              match app-id="qalculate-gtk"
              open-floating true
              default-column-width { fixed 400; }
              default-window-height { fixed 400; }
      }

      window-rule {
              match app-id="Alacritty"
              open-floating true
              default-column-width { fixed 900; }
              default-window-height { fixed 900; }
      }

      window-rule {
              match app-id="Spotify"
              match app-id="spotify"
              open-on-workspace "spotify"
              open-maximized true
      }

      window-rule {
              match app-id="vesktop"
              open-on-workspace "discord"
              open-maximized true
      }

      window-rule {
              match app-id="org.cctv-viewer.cctv-viewer"
              open-on-workspace "cameras"
              open-maximized true
              opacity 1.0
      }

      window-rule {
              match app-id="VirtualBox Manager"
              open-on-workspace "virtbox"
              open-maximized true
      }

      window-rule {
              match app-id="Element"
              open-on-workspace "element"
              open-maximized true
      }

      window-rule {
              match app-id="GoogleMessages"
              open-on-workspace "messaging"
              open-maximized true
      }

      window-rule {
              match app-id="org.kde.kdeconnect.sms"
              open-on-workspace "messaging"
              open-maximized true
      }

      window-rule {
              match app-id="org.gnome.Geary"
              open-on-workspace "messaging"
              open-maximized true
      }

      window-rule {
              match app-id="googlecalendardark-nativefier-e22938"
              open-on-workspace "messaging"
              open-maximized true
      }
    
      window-rule {
              match app-id="feh"
              open-floating true
              default-column-width { fixed 1200; }
              default-window-height { fixed 800; }
      }

      window-rule {
            match app-id="niri-hot-change"
            open-floating true
            default-column-width { fixed 1050; }
            default-window-height { fixed 500; }
      }

      layer-rule {
              place-within-backdrop true
      }
#+END_SRC

* Bindings
This is the bindings data section. Each key binding is loaded into a python dict which contains
5 columns:

1) Keybinding - the key sequence (e.g. Mod+Shift+X).
2) Command - the command to invoke (.e.g. "floorp").
3) Spawn {Y | N} - if a spawn command needs to be prepended to the command.
4) Description - A description of the binding to be used for a custom hotkey overlay.
5) Target {"" (all) | all (common) | desktop | laptop | omit} The target system for the keybinding. If
   the target is left blank it will generate all keybindings (with the exception of "omit" which
   omits any key binding from output and useful for commenting bindings) which is used for documenting
   the overlay. If you pass a target system in like "desktop" it will return the commond
   bindings use across all systems plus the desktop specific ones.
#+NAME: keybindings-data
#+BEGIN_SRC python :noweb= yes :results value :var _niri_hot_change=niri_hot_change :var _bindings=bindings :var _launcher=launcher :var _bluetooth=bluetooth :var _power_menu=power_menu :var _music=music :var _network=network :var _show_windows=show_windows :var _emacs_prod=emacs_prod :var _emacs_dev=emacs_dev :var _file_gui=file_gui :var _file_term=file_term :var _browser=browser :var _notes=notes :var _sms_get=sms_get :var _sms_put=sms_put :var _email_get=email_get :var _email_put=email_put :var _scratchpad_put=scratchpad_put :var _scratchpad_get=scratchpad_get :var _term=term :var _lock_screen=lock_screen :var _audio_raise_volume=audio_raise_volume :var _audio_lower_volume=audio_lower_volume :var _audio_mute=audio_mute :var _audio_mic_mute=audio_mic_mute :var _screenshot_viewer=screenshot_viewer :var _screenshot_viewer_emacs=screenshot_viewer_emacs :var _niri_theme_change=niri_theme_change :var _lobindings=lobindings :var _term_foot=term_foot :var _term_wezterm=term_wezterm :var _wallpaper_switch=wallpaper_switch
  return [
      ("Mod+Shift+Slash", _bindings, "Y", "Niri Key Bindings", "all"),
      ("Mod+Slash", _lobindings, "Y", "LibreOffice Key Bindings", "desktop|laptop"),
      ("Mod+D", _launcher,"Y", "Launcher", "all"),
      ("Mod+B", _bluetooth, "Y", "Bluetooth", "all"),
      ("Mod+Shift+D", _show_windows, "Y", "Show Active Windows", "all"),
      ("Mod+E", _emacs_prod, "Y", "Emacs - Prod", "all"),
      ("Mod+Shift+E", _emacs_dev, "Y", "Emacs - Dev", "desktop"),
      ("Mod+Shift+Y", _file_term, "Y", "File Manager - Term", "desktop"),
      ("Mod+Shift+N", _notes, "Y", "Notes", "desktop"),
      ("Mod+1", _sms_get, "Y", "SMS Get", "desktop"),
      ("Mod+Shift+1", _sms_put, "Y", "SMS Put", "desktop"),
      ("Mod+2", _email_get, "Y", "Email Get", "desktop"),
      ("Mod+Shift+2", _email_put, "Y", "Email Put", "desktop"),
      ("Mod+P", _scratchpad_put, "Y", "Scratchpad Put", "all"),
      ("Mod+Shift+P", _scratchpad_get, "Y", "Scratchpad Get", "all"),
      ("Mod+Return", _term_foot, "Y", "Terminal - Foot", "all"),
      ("Mod+Shift+Return", _term_wezterm, "Y", "Terminal - Wezterm", "all"),      
      ("Mod+Shift+S", _screenshot_viewer, "Y", "Screenshot Picker", "desktop"),
      ("Mod+Ctrl+S", _screenshot_viewer_emacs, "Y", "Screenshot Picker - Emacs", "desktop"),
      ("Mod+T", _niri_theme_change, "Y", "Niri Theme Change", "lenovo"),
      ("Mod+T", _wallpaper_switch, "Y", "Change Wallpaper", "laptop|desktop"),            
      ("Mod+Shift+T", _niri_hot_change, "Y", "Niri Hot Change Config", "desktop"),
      ("Mod+S", "screenshot", "N", "Screenshot", "all"),                                        
      ("Mod+O repeat=false", "toggle-overview", "N", "Toggle Overview", "all"),                           
      ("Mod+Q", "close-window", "N", "Close Window", "all"),                                       
      ("Mod+h", "focus-column-left", "N", "Focus Column Left", "all"),                
      ("Mod+j", "focus-workspace-down", "N", "Focus Workspace Down", "all"),                                       
      ("Mod+k", "focus-workspace-up", "N", "Focus Workspace Up", "all"),                  
      ("Mod+l", "focus-column-right", "N", "Focus Column Right", "all"),                                      
      ("Mod+Shift+h", "move-column-left", "N", "Move Column Left", "all"),                                  
      ("Mod+Shift+j", "move-window-down", "N", "Move Window Down", "all"),                               
      ("Mod+Shift+k", "move-window-up", "N", "Move Window Up", "all"),                               
      ("Mod+Shift+l", "move-column-right", "N", "Move Column Right", "all"),                                
      ("Mod+Ctrl+h", "focus-monitor-left", "N", "Focus Monitor Left", "desktop"),                                 
      ("Mod+Ctrl+l", "focus-monitor-right", "N", "Focus Monitor Right", "desktop"),
      ("Mod+Shift+Ctrl+h", "move-column-to-monitor-left", "N", "Move Column To Monitor Left", "desktop"),
      ("Mod+Shift+Ctrl+l", "move-column-to-monitor-right", "N", "Move Column To Monitor Right", "desktop"),
      ("Mod+WheelScrollDown cooldown-ms=150", "focus-workspace-down", "N", "Focus Workspace Down", "all"),
      ("Mod+WheelScrollUp cooldown-ms=150", "focus-workspace-up", "N", "Focus Workspace Up", "all"),
      ("Mod+Shift+WheelScrollDown", "focus-column-right", "N", "Focus Column Right", "all"),
      ("Mod+Shift+WheelScrollUp", "focus-column-left", "N", "Focus Column Left", "all"),
      ("Mod+Tab", "focus-workspace-previous", "N", "Focus Workspace Previous", "all"),
      ("Mod+BracketLeft", "consume-or-expel-window-left", "N", "Consume Or Expel Focused Window Left", "all"),
      ("Mod+BracketRight", "consume-or-expel-window-right", "N", "Consume Or Expel Focused Window Right", "all"),
      ("Mod+Comma", "consume-window-into-column", "N", "Consume Window Into Column From Right", "all"),
      ("Mod+Period", "expel-window-from-column", "N", "Expel Bottom Window From Column To Right", "all"),
      ("Mod+R", "switch-preset-column-width", "N", "Switch Preset Column Width", "all"),
      ("Mod+Shift+R", "switch-preset-window-height", "N", "Switch Preset Column Height", "all"),
      ("Mod+Ctrl+R", "reset-window-height", "N", "Reset Window Height", "all"),
      ("Mod+F", "maximize-column", "N", "Maximize Column", "all"),
      ("Mod+Shift+F", "fullscreen-window", "N", "Fullscreen Window", "all"),
      ("Mod+Ctrl+F", "expand-column-to-available-width", "N", "Expand Column To Available Width", "all"),
      ("Mod+C", "center-column", "N", "Center Column", "all"),
      ("Mod+Ctrl+C", "center-visible-columns", "N", "Center Visible Columns", "all"),
      ("Mod+Minus", "set-column-width \"-10%\"", "N", "Set Column Width -10%", "all"),
      ("Mod+Equal", "set-column-width \"+10%\"", "N", "Set Column Width +10%", "all"),
      ("Mod+Ctrl+Minus", "set-column-width \"-1\"", "N", "Set Column Width -1", "all"),
      ("Mod+Ctrl+Equal", "set-column-width \"+1\"", "N", "Set Column Width +1", "all"),
      ("Mod+Shift+Minus", "set-window-height \"-10%\"", "N", "Set Window Height -10%", "all"),
      ("Mod+Shift+Equal", "set-window-height \"+10%\"", "N", "Set Window Height +10%", "all"),
      ("Mod+Shift+Ctrl+Minus", "set-window-height \"-1\"", "N", "Set Window Height -1", "all"),
      ("Mod+Shift+Ctrl+Equal", "set-window-height \"+1\"", "N", "Set Window Height +1", "all"),
      ("Mod+V", "toggle-window-floating", "N", "Toggle Window Floating", "all"),
      ("Mod+Shift+V", "switch-focus-between-floating-and-tiling", "N", "Switch Focus Floating And Tiling", "all"),
      ("Mod+W", "toggle-column-tabbed-display", "N", "Toggle Column Tabbed Display", "all"),
      ("Mod+Shift+Space", "switch-layout \"prev\"", "N", "Switch Layout - Prev", "all"),
      ("Mod+Escape allow-inhibiting=false", "toggle-keyboard-shortcuts-inhibit", "N", "Toggle Keyboard Shortcuts - Inhibit", "all"),
      ("Ctrl+Alt+Delete", "quit", "N", "Quit", "all",),
      ("Mod+Space", '\"qs\" \"-c\" \"DankMaterialShell\" \"ipc\" \"call\" \"spotlight\" \"toggle\"', "Y", "Launcher", "all"),
      ("XF86AudioRaiseVolume allow-when-locked=true", _audio_raise_volume,"Y", "Vol+", "all"),
      ("XF86AudioLowerVolume allow-when-locked=true", _audio_lower_volume,"Y", "Vol-", "all"),
      ("XF86AudioMute allow-when-locked=true", _audio_mute,"Y", "Mute", "all"),
      ("XF86AudioMicMute allow-when-locked=true", _audio_mic_mute,"Y", "Mic Mute", "all"),            
      ("XF86AudioRaiseVolume allow-when-locked=true",'\"qs\" \"-c\" \"DankMaterialShell\" \"ipc\" \"call\" \"audio\" \"increment\" \"3\"', "Y", "Vol+", "omit"),
      ("XF86AudioLowerVolume allow-when-locked=true",'\"qs\" \"-c\" \"DankMaterialShell\" \"ipc\" \"call\" \"audio\" \"decrement\" \"3\"', "Y", "Vol-", "omit"),
      ("XF86AudioMute allow-when-locked=true",'\"qs\" \"-c\" \"DankMaterialShell\" \"ipc\" \"call\" \"audio\" \"mute\"', "Y", "Mute", "omit"),
      ("XF86AudioMicMute allow-when-locked=true",'\"qs\" \"-c\" \"DankMaterialShell\" \"ipc\" \"call\" \"audio\" \"micmute\"', "Y", "Mic Mute", "omit"),
      ("XF86MonBrightnessUp allow-when-locked=true",'\"qs\" \"-c\" \"DankMaterialShell\" \"ipc\" \"call\" \"brightness\" \"increment\" \"5\" \"\"', "Y", "Brightness Up", "omit"),
      ("XF86MonBrightnessDown allow-when-locked=true",'\"qs\" \"-c\" \"DankMaterialShell\" \"ipc\" \"call\" \"brightness\" \"decrement\" \"5\" \"\"', "Y", "Brightness Down", "omit")
  ]
#+END_SRC


This is the keybindings-config code block which returns the keybindings base on the
target system. There is mode option which will return the keybinding content to
be used for configuration use or doc use.
#+NAME: keybindings-config
#+BEGIN_SRC python :var data=keybindings-data :var ts="" :var mode="config"
def _match_target(target, ts):
    ts = (ts or "").strip().lower()
    # Normalize the binding's target into a lowercase set
    if isinstance(target, (list, tuple, set)):
        tset = {str(x).strip().lower() for x in target if str(x).strip()}
    else:
        # allow single strings, or pipe/comma separated (e.g., "desktop|laptop")
        s = str(target or "")
        s = s.replace(",", "|")
        tset = {p.strip().lower() for p in s.split("|") if p.strip()}

    if "omit" in tset:
        return False
    if "all" in tset:
        return True
    return ts in tset

lines = []

for mod, cmd, spawn, desc, target in data:
    # target is the binding's target (string or tuple/list); ts is the single requested system
    if _match_target(target, ts):
        if mode == "config":
            if str(spawn).upper() == "Y":
                lines.append(f'{mod:50} {{ spawn {cmd}; }}')
            else:
                lines.append(f'{mod:50} {{ {cmd}; }}')
        elif mode == "doc":
            lines.append(f"{mod:50} {desc}")

return "\n".join(lines)
#+END_SRC

Keybindings config evaluator.
#+BEGIN_SRC kdl :noweb yes :tangle ./config.kdl :eval no
   binds {
      <<keybindings-config(data=keybindings-data, ts=target-system, mode="config")>>          
   }
#+END_SRC

This generates the keybindings documentation and writes it to a text file that is
referenced by a custom overlay displayed using a keybinding + rofi.
#+BEGIN_SRC kdl :noweb yes :tangle ./key_bindings.txt :eval no
  <<keybindings-config(data=keybindings-data, ts=target-system, mode="doc")>>
#+END_SRC
